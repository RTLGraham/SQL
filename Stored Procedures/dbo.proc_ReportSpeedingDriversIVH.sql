SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO

CREATE PROCEDURE [dbo].[proc_ReportSpeedingDriversIVH]
	-- Add the parameters for the stored procedure here
	@did NVARCHAR(MAX) = NULL, 
    @uid UNIQUEIDENTIFIER = NULL,
	@sdate DATETIME = NULL, 
	@edate DATETIME = NULL,
	@highonly BIT = NULL
AS

	/* Test data */
	--DECLARE @did NVARCHAR(max),
	--		@uid UNIQUEIDENTIFIER,
	--		@sdate DATETIME,
	--		@edate DATETIME,
	--		@highonly BIT 

	--SET @did = N'7793342D-FF5E-46AD-91F9-001EECB166D2,FEDBC244-3A60-4B49-9B10-014931CCA5B2,BC19E8AD-9560-400A-994B-022CDECDC0AB,6430220D-AAA4-4E3D-A14F-04070A9DD9E5,EBBF5159-1115-4E8B-8FA6-046081D56145,F7CEB2CA-BE5C-4262-BBEB-04C2566123A4,177A3D11-0C6B-4E78-BECE-04D2B3A6E19C,11D26996-1332-460B-B808-053AD4F8875F,68E2F35A-E39D-47B0-9B0D-0A1C2071B269,ADD71A3A-2EBC-44B8-A936-0AFB70D30FFC,EECE1DD3-7420-474F-B0C1-0BD71C0EA4B7,F08697BA-4A0C-4465-9A37-0C2984057351,BA60CB6E-CC93-4192-9721-0C5572EAE734,91C23A23-3322-475D-AEF4-0D254EC004A9,96040E58-180E-4791-9B16-0D3F0CD233D7,52C3F682-DB24-4F30-AA98-0D57BEF1F131,118AC9B2-9135-4F90-ADDC-0D6324BE8917,27BF8445-AA7A-458C-B7D1-0E7AEB193125,8AD3868A-7BCB-46B7-9FC0-0F42F79EB0E5,3A6DB410-713A-4FB5-B1AE-0FF3A9113E40,A03EC7DF-A879-436F-A537-137378A09CE2,AD9BEA6C-D062-42A1-A385-14D8C90EB8C4,AABA73C9-DCD1-40A2-8BFC-15232369D42B,98D25211-30F9-4FDE-A7AA-163C1F994D2F,D7380F5F-E915-4FB6-86F9-1816964DE8F0,29EB3E7E-DC1E-4194-883A-18B55EBC6254,24263C0B-E1A0-4DBD-A2F0-1902038CB7EE,0998394A-5D06-4EDD-B882-1AB42C653983,E114AB02-36A0-42D5-B07C-1AEE5E54462D,ADC6A822-EFA7-4EB4-9485-1B35AF81A1AB,51650147-ACEA-40A4-8D66-1BA0F6805977,53F0FFE7-9089-4C17-AA86-1F77C712798D,2C830A4B-9E57-4F2A-8DD2-20BCD58DA878,765ECD0E-5297-4FC7-B5E2-22F6EB7453D6,1E1B3514-68F5-41A7-B748-241BBABBD28D,1968DE30-6BDC-452E-A7F8-247FEA71ACEF,9FF4BD56-FF47-437C-8DA6-253AE01FAC62,FFD97949-0239-4E2D-B260-264320527E6A,3B626C69-0C47-4D14-B945-26A8A737BBBC,DC7915E3-9529-4583-9273-282D9099E3F9,DF663C69-6FE7-43A2-81CB-299E9D1B2238,E319292D-02DE-4960-B594-2A10E0C52D45,CED2E3D0-A248-4A5E-B5F1-2B37E6D35D8B,A1383B8A-B968-44AF-8168-2BB196ECCB26,7B122FC8-0912-4C47-9BB3-2C07159CD810,CB8D4940-E88C-4B89-8CE4-2C1693C9E4AA,61B0A26F-B7D4-4D8B-886F-2E040E9530B5,6CB32BC9-6F57-4A75-8BED-2E06918C7B57,0420B261-405F-4574-B3A3-30B1EEF129D0,E3600BED-A9BD-4FF9-A3A3-30C24CEA228F,439C237E-F7BF-4834-8467-30DED100E14A,AA4E9901-4FAE-4E68-AC12-3218F08DCCA8,A456098D-6EAB-428D-AA6F-32FE0715C2AD,E2B43590-D5F3-41FA-B25B-3318CB83320E,BF45095D-A6CD-4B62-AC58-339D5476F4E4,33A3DBAE-6002-4B25-9182-34867AE3245D,F734B783-2192-4005-91F8-34D1AC8B3009,476E5853-FD3A-4AF5-BA7C-35C1C07AAB3D,EAC84E7C-0932-4C32-A8EF-361361BF5717,0FAB5490-A0C6-495D-82E3-37D77B22F370,8F307272-B9F0-4741-BA90-3A1FE610A662,B3D463BC-883A-4C5F-802C-3A2EEFD8D853,E15A4AE7-3831-4374-A45B-3AF55AC157F1,F0414C52-416D-45BE-9D21-3C6981F61A94,076E6F18-323D-43DB-B588-3D4AC691B1BA,174BB3C2-3B42-410D-B618-3E3AF45849A9,7EB100E7-73DF-4967-BED2-4126F3CA7863,0570CE29-6D48-425A-B130-42E0054F7924,E45C80FF-062B-4DB7-9133-43233B6253D1,A9B65080-839C-4F33-9FDC-446508DFC795,A746036C-B2E0-43CF-ADE0-4500F036EABA,0017FBB2-FA82-41C1-8AC3-4517081ED082,1A8DC5DB-2BE3-4BFF-9E64-46C6AFB302AE,47279BDB-7F4A-4796-A1D0-470BA158063A,78F17C52-737A-4E78-9F8A-490711950734,0BFCF3B1-5C41-47AB-9C0C-4BD7A1CE8500,8369CC4A-B6B0-4F87-8EB9-4C4E8A7E6135,BF8AE132-43A5-402F-95BC-4CADB3BE646F,B81AE707-0878-460A-A69C-4CC75C3E5FF6,7E8AE1ED-67D5-46C2-97AC-4F14C461FB9A,C11A4F21-598C-4957-9A7A-4F5B00E8FAE4,5647970F-8AB0-477A-94DA-4F8BFB9F16DD,BFC87B67-F94F-41F0-A558-4FAE1FCBD3EF,4741B925-FC6E-4E78-A97E-50AE515088D2,2B59A59F-789A-4DFE-A35A-51D7990D5D96,F4A53B9C-288D-437F-80B8-52B837F4870B,CD2F4616-A62F-44DF-B547-538ED4EB0E39,2CEF869D-6988-42F1-8461-543177CCA65A,59979B43-44A9-4F41-88F5-567DD578F6B8,EB67BE1E-54D9-4E75-9774-56A9D2F5AEA0,E4F7A2C4-424D-49D3-8DDA-57A1D1198B73,36F47F9A-37C7-416E-AB81-5864F2664D36,E516FA1F-469A-408C-A09D-5A1194A6521D,DA89E32F-E4A8-42A8-99AC-5AB3592F3AEF,AC260072-101D-4AEB-9CCF-5AD3F791EA7C,CBACB8A1-0358-4BA4-B210-5B446297903A,998ACAA6-6F4D-40C2-9375-5C1F02771A3C,42557752-0E26-4FB1-A42F-5CBC1AEF284A,D462C891-275A-4D0C-870B-5CFABEE1C281,69C2AD55-AC3E-4338-976B-5D151022CAC7,537FF4EC-A553-4A05-A7DA-5E4C17E8265A,86F14726-6791-4F64-ADFF-637775C297DD,FA20B44E-F763-445D-8E0F-64D469D6F8B9,E07FDA34-BEFD-4E26-9B18-652A40A31C44,42234805-A7F4-4295-B29A-65EA24BFB60A,1FABCBEC-5CDD-4AB7-986F-67C869F01B96,4E4CC185-B93A-4C9A-AB0D-69E37B15820F,70D852A3-8D51-47DD-A0DC-6C072CC4F508,A19D79EF-0278-4BB5-ADBC-6CCD0F13147C,BE6B7822-9F55-4E72-8047-6DDF1C958721,21DF5FE1-CFE7-4A14-803D-6DE5A92EA707,DE278B6D-494E-42F7-A318-6DEE263D1534,60ECF357-D462-4ABE-B3A7-6E29067C3221,CE805CA7-1E41-41DC-9FBB-6FCD5172025C,5930F11B-3BC6-44D5-B403-7059C3324387,2711D900-1D04-4EA5-AC20-71AA7FC18E72,7BCB4FC1-8BAC-41FA-8C23-72EC2BCB08B6,48BEC851-D521-437F-B27E-74FC0AD97D51,9290ABB0-F846-4029-BE17-75A4F2552CFF,4E63ABF6-58B3-489B-937A-75ECED2C6DC0,11D48F0E-6511-478F-8C9D-7668D9D2F345,4EE89AD4-0886-405A-BA1B-7762F4B4F200,7EFF3E55-C44D-4A5F-9658-79FF845306E9,644F2AE2-65D7-4130-A02D-7C61CB6F0E1F,66569A28-423C-4FAD-87DA-7CA1F48F3D77,431F556E-9CA7-459E-AB1A-7CC07B1D9979,6550D2F6-C443-47FA-AE96-7D15D9D41912,9F8C70CB-9311-48F3-A348-7DF2343BBF23,33300D59-F1A7-4129-BF45-7F87AC86CB5F,4764FD50-4664-40DC-B5FC-80C9B922D7D8,BC270860-FFBB-4379-94AC-80DF73056387,80C2F39B-A114-4290-8FAB-84429C133505,5D810E5B-A9B8-437E-ABBB-845F0509A07B,CFF4FBAA-3142-4C57-927F-872A3BF1ADCB,2BD353B9-40AF-432C-A3B5-8868F6656D00,DFA4A871-0CCB-439B-8319-8A543E3B278D,9EDE0C39-AF31-4F78-A347-8BA689C65862,17D620FA-A324-48DC-989E-8C6E077B19F3,DE4CCBB6-B1DB-4808-89D1-8CFFE98236FD,8F96C391-F309-4C38-9327-8E2CA45FC01C,1538FE43-BE47-410C-B395-907857392661,9C4110FF-FABD-4144-9EC9-90EE1E38FD7E,B879CDD1-B407-4AAC-A1A0-912F78BE5A4E,FE9AF2E9-EF0F-44A7-861A-9143C05BCA6E,39E40F0F-9038-48A6-A1CB-92081728D7EE,DB871CE9-8A72-4D7A-9928-927BEA0EB46A,0AF0815B-B3A4-46E3-81FD-93B840B57E35,A8D312AD-4634-4017-84E3-95E27F3C04AE,34F38D4E-5E40-4086-8460-96C2482F96B1,34B27D7C-5989-41E5-981E-97707C6C3F7F,8AC6FDD1-076B-4BFE-BAA4-97793D0D0893,8E3E08DD-6D09-4F93-BCB3-977BFEF12B2C,D02D69B9-6548-4DBB-9731-9922C81438C2,DC67B8AD-A139-4397-8800-999DCEFBBA1A,3AD98448-C2AB-4C6A-932A-9BF5C52B6B27,4D528654-C0C5-4D08-95B4-9C4FBD920590,E2F885F7-95F7-4E11-A1D5-9C87366C646F,4063A4E3-CA49-48F0-85D0-9CA782887C35,E1D70F0C-393A-4797-A6B9-9D1DC63BE61B,EE4F3223-18B4-4021-81F0-9D69C62797A1,ABEFA946-846B-4D14-98D5-9E1C8C049EF3,D5B58901-16B2-4954-B62D-9F9FED6D2C30,4956054D-26A0-4F13-AAC9-9FA02C32EB1D,47BBF727-6E7E-43E0-A1BC-9FE61791EBAE,5570D24B-B539-4B15-9EA6-A1884AF5FA5A,26C2F1DF-F396-410C-B911-A1B544313185,53507EB3-1E25-4E88-9329-A89A7AEDE915,D922433A-53CD-426C-8927-A99FEC866A64,ADF62A5B-7483-4B45-9C6D-A9BDABC61E16,AA3DAE39-9F79-494E-8B6C-ACC8882637D5,70F87545-09C4-44D5-A701-ADE38E377C61,ED4C9DA4-F8FA-436D-8E02-AE69E35F739C,C4DEC0ED-D358-40A9-9B03-AFA54A55DF52,EE0735A8-DBD8-40FD-A657-B000217B2DD3,463DD8BF-CC44-4351-B9C0-B36CF3CB8D69,2F7C45CD-ABE6-48D4-B071-B379917A1A18,1DEDFEDA-3114-43F3-8F9F-B526C39A271A,BFC9BD83-78D8-47FA-9E96-B6591DD16648,61D8E4C4-FDE0-4FE8-9D18-B6F5EC36F325,63BE3851-010F-48BF-94CA-B6F693367DA5,F9241CAF-EC00-4787-8DDB-BA0489E3D787,F8B4FCA1-46A3-41CC-A066-BAB9DF6BF44D,2345B50A-93AF-484C-8E1C-BCF2F1CD71FB,A4A5043E-6CBF-4488-9FF4-BD3D81611E13,14988855-9203-4453-858C-BE5D160A1926,212B7C68-BCAC-4C9F-A3C8-BF3994BA4F90,9ED13BAD-56D9-41D0-82AA-BF6332A82FAF,7219BB58-2618-4089-BC52-C135FF09D77E,CD9701D9-4637-40CC-A1B2-C30499C46AF6,283DBFF3-FA40-46A4-937C-C324DEF93F5C,86860943-AD9B-4BF4-9158-C5316E3DA236,0F4A50C2-902C-46B1-89FD-C65638162C3D,AB0FBA01-3A60-4CC1-A3C9-C6565BF137EE,4C010145-5B0E-4DC7-8483-CB9568D0F863,85568FB1-2790-4CD6-BABF-CBC287074EC6,19EB52C7-326B-4566-B022-D25C65775E15,05D90CFE-C99E-4A46-862A-D38081375B01,0BEC37DF-C145-4362-9B9A-D393ECED8DED,EE841EB8-0275-4574-9690-D3B971458E26,6C730744-DB8E-4DE2-BF2B-D73846BE9040,86C83CFD-FB81-4228-B30A-D8DAE14D2D20,7A249A75-8C15-45D1-8DCB-DABB6851BDAF,D534C4FA-6993-44DC-B122-DABC0C1B2A71,97220E8B-E683-4CD9-88EF-DAF5A69C0667,41472E37-DF8C-426E-8D63-DB41F5DB51FA,A3AC0E28-20B0-4595-BD78-DBD3B107B9F9,60DE1BE6-5511-4765-BE88-DD7D47904302,90D2C339-C725-4EA6-A38B-DF8B620F5008,1FEBE3F2-8142-455C-B4CD-E17709E2A59D,835DA213-A7E5-47C0-81EA-E1B1BCAF1543,3123C31A-6CAA-4BA6-AAB6-E20AC926095A,91F27B55-09C7-4259-B7B8-E25632B06663,5DCFE3E0-2016-42CA-A564-E49AD7364CCA,1DFBB772-DA90-4B64-900F-E635D65F401A,74B6C758-B436-48BF-B671-E87D79507FE1,3EBEE4A7-884F-4725-8733-EA85AB0F7C5B,CE618FD1-0526-46E2-85DF-EAD2A5751357,2DEE2B60-EBA3-4F41-89E9-EBBE01FCC991,C3B81F88-253A-442C-92A0-EC0C8EA5AAB7,2E0C37A0-C2F2-4C09-903D-EC1DD3601830,6450645D-1FBB-4DF7-AE9F-EC393B7C727E,73BC7D25-1BF3-42F5-9197-ED7E34D64C21,B1963C78-83C6-417A-9ED5-EDE1AF868FB8,67792E78-5225-47F9-8152-F02FB328E5FC,204CA7A9-9458-4D80-8825-F1C688E3648D,3AAE51F5-0133-4AF1-8849-F1D0CDE20672,AA8449BE-72DA-43BA-90DC-F29D7919595E,20AB3E95-2A98-4C1A-9456-F32D1282D902,468BE74D-E7F9-4FD4-9468-F3BE7823BAAF,3E3487A7-A588-440A-9DB9-F40DDF7AAC1E,B12BF926-6ED3-4CDD-8C9A-F5B9BC01E125,C9FCB3E6-D199-4277-A089-F5C15C40FE0C,8DA43E83-270B-4DB0-B1B1-F61BE1A855EF,A47F5117-BF98-4B28-8C42-F61EDAE8A56A,B728BD9B-3B6F-44F8-9A54-F6829D625132,4B2EC291-D937-4578-99A8-F8148BE72576,182DADEE-F012-4E71-9A2F-F922BA6EE708,D3F5E8B9-A293-4179-85C2-F9BA38F675AA,50E2A487-86D1-4ACB-9EEC-F9F7410DBC3E,254346B9-954D-4347-B7C9-FA0833D9E0F7,ABA1BB8D-7163-4306-B81E-FD212A751322,2CEFDAED-4042-4D9D-9269-FF1209BB81B8'
	--SET @uid = N'2A1588D7-DE7F-4014-BAA9-CDD64FB4C183'
	--SET @sdate = '2018-03-07 00:00'
	--SET @edate = '2018-03-07 23:59'
	--SET @highonly = 0

	/* Swap parameters */
	DECLARE	@lsdate datetime,
			@ledate datetime,
			@luid UNIQUEIDENTIFIER,
			@ldid varchar(max)

	SET @lsdate = @sdate
	SET @ledate = @edate
	SET @luid = @uid
	SET @ldid = @did

	/* Declare and Set essential variables */
	DECLARE @speedunit VARCHAR(10), 
			@timezone VARCHAR(255),
			@s_date DATETIME,
			@e_date DATETIME,
			@speedmult FLOAT,
			@vehicleId UNIQUEIDENTIFIER,
			@sql NVARCHAR(MAX),
			@eventtime DATETIME, 
			@cid UNIQUEIDENTIFIER,
			@thpercent FLOAT,
			@thvalue FLOAT,
			@thpercentValue FLOAT,
			@thvalueValue FLOAT

	SELECT @speedunit = dbo.UserPref(@luid, 209)
	SELECT @timezone = dbo.UserPref(@luid, 600)
	SET @s_date = [dbo].TZ_ToUTC(@lsdate,@timezone,@luid)
	SET @e_date = [dbo].TZ_ToUTC(@ledate,@timezone,@luid)
	SET @speedmult = CAST([dbo].[UserPref](@luid,208) AS FLOAT)

	SELECT @cid = CustomerID FROM dbo.[User] WHERE UserID = @luid
	SELECT TOP 1	@thvalue =		CASE	WHEN @highonly = 1 
											THEN OverSpeedHighValue 
											ELSE OverSpeedValue END, 
					@thpercent =	CASE	WHEN @highonly = 1 
											THEN OverSpeedHighPercent 
											ELSE OverSpeedPercent END,
					@thpercentValue = OverSpeedHighPercent,
					@thvalueValue = OverSpeedHighValue
	FROM dbo.Customer 
	WHERE CustomerId = @cid

	IF @thpercent IS NULL SET @thpercent = 0
	IF @thvalue IS NULL SET @thvalue = 0

	SELECT	v.VehicleId,  
			v.Registration,  
			v.VehicleTypeID, 
			CAST(e.Speed * @speedmult AS INT) AS Speed,  
			[dbo].[GetCMD_IVH_Overspeed](v.VehicleId, e.EventDateTime, e.Speed) * @speedmult AS SpeedLimit,
			[dbo].[TZ_GetTime]( e.EventDateTime, @timezone, @luid) AS EventDateTime, 
			e.Lat,  
			e.Long AS SafeNameLong,  
            e.Heading,
			@speedunit AS SpeedUnit,  
			[dbo].[GetGeofenceNameFromLongLat] (e.Lat, e.Long, @uid, [dbo].[GetAddressFromLongLat] (e.Lat, e.Long)) AS RevGeocode,
			dbo.FormatDriverNameByUser(
				dbo.GetCurrentDriverByEventDateTime( e.VehicleIntId, ISNULL(i.IVHTypeId,0), e.EventDateTime, d.DriverId ),
				@luid) AS Drivername,
			CAST(0 AS BIT) AS IsHigh
	FROM	dbo.Event e WITH (NOLOCK)
				INNER JOIN dbo.Driver d ON e.DriverIntId = d.DriverIntId
				INNER JOIN dbo.Vehicle v ON e.VehicleIntId = v.VehicleIntId
				/* LEFT JOIN to support cameras*/
				LEFT OUTER JOIN dbo.IVH i ON v.IVHId = i.IVHId
	WHERE	e.EventDateTime BETWEEN @s_date AND @e_date
			AND e.CreationCodeId = 39  
			AND d.DriverId IN (SELECT VALUE FROM dbo.Split(@did, ',')) 
	ORDER BY e.EventDateTime ASC


GO
