SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO

CREATE PROCEDURE [dbo].[cuf_Vehicle_CameraOffReport]
(
	@uid UNIQUEIDENTIFIER,
	@vids NVARCHAR(MAX),
	@sdate DATETIME,
	@edate DATETIME
)
AS

	
	--DECLARE	@uid UNIQUEIDENTIFIER,
	--		@vids NVARCHAR(MAX),
	--		@sdate DATETIME,
	--		@edate DATETIME
			
	--SELECT  @sdate = '2016-01-01 00:00',
	--		@edate = '2016-01-31 23:59',
	--		@uid = N'988D25DE-65E9-4FC5-8981-3D2B4EA0FEAB',
	--		@vids = N'12626673-DDF9-4658-9CAC-B361C2CD9D8A,2A7169A2-337E-41B6-B5C2-8F0B9A9EF37E,A09B8049-DFF6-40D8-801A-AF509B8EB1D1,A6D92344-6DD6-469E-9FC9-BB87021F0EF9,C518E682-B62F-447B-B223-DC204ED0B2C3,F029F419-FB15-4EAB-9A3E-3E3A6378EABB,993EEB7F-E512-4FA5-8962-395A98DEC529,7B23FD77-22DB-4331-A7C5-8BA36CAC9028,A4EBDCAD-FB6B-4B88-8C48-6046F22990E6,50D9473D-F1B4-44F6-A865-4606AF659745,ED7107B7-72BC-4621-A58A-6AC214668F23,71517545-EABE-4939-94E6-89722C1DA3CE,E8FE364C-AF52-4954-8333-13CA86254273,C61F0267-EC4D-42E3-8162-AFEED6A2E151,FD4927AA-B71E-4CC4-93F9-325F28785465,267DECE4-16D2-47B0-A4DB-F5944E8B5CB6,18D277D9-A808-4203-9DC3-7C38BE667196,8B26DFCE-75B5-44AA-8D11-8F8FEB7D3AED,D3C09512-2815-4FE0-BB98-3550FBCE065D,9E9DFA2D-74EA-455A-B085-6DD91E4C8F3E,D851F5CE-18BF-4D5F-9C89-8D1355EF4867,656B6B97-9209-4CD5-87D9-A17405CE49F5,5C308C6D-F7DB-4D4C-81AF-D4C6F37AFA17,9D784848-44B7-420C-B200-1D10411A69F4,C88F2276-3169-4025-BB60-2B4D9534A0FE,39B59B67-831B-4E23-A1C5-A07B10736E91,9C68B78A-FBAE-4CF2-8F3F-12C92BA05765,CCE1C6B2-2AD1-4274-A908-CEAA50631187,D664A237-B70A-42AE-9218-FEA2444E7B02,01F5DA1C-AAB4-42C0-8C24-848E22E89ECE,1ED53E8F-AF55-405E-9586-A0F7244E6F95,49939D7B-5138-4F07-A447-5242724C3124,ACE89D2E-ABAB-4FAE-95A1-ED5A7E477B45,9980D484-1CDA-4F81-A0E6-760389A1AC1C,563E59C4-E6A7-4E17-A655-03AA6BE108DC,14CAD3A5-DB98-4B85-9C35-376813FD7AA9,7901CD71-9674-445B-B82E-AAAE3DE16C50,C8897213-1D47-43A1-8D07-1DA41AC99687,A2D23CD1-6782-409B-AB5D-14EAAE194DFD,6C4B0870-1C92-4668-96FD-167783CDABFE,316492DD-6CC0-41E0-92C0-AF85D5FBF2D6,69079EDE-F7EC-4793-B748-26C3D9153241,D724FB59-9261-4E27-86D3-BB7966319D3A,90F32FCD-2995-4282-9D8B-6636579B3785,B02CB28D-05CE-49A4-807A-566DBDCBD1C7,9DD711CD-F2DD-4345-9F8A-E32D807123ED,8AE54D11-D5CE-4915-A2B8-508C7E72E253,19951C09-3019-44DF-82CE-03DA25E3327C,5DB34E58-8735-434D-BE06-C89C4C752503,4130E7E0-EBF0-4BC9-9FBB-E07F3C1FFB9E,E2CBA582-D288-4B41-930D-CE844A4D78CB,1C4E1D13-1E87-4E14-B85D-4E32098A9ADD,02A1741C-B452-4C16-89C6-6A3B763A6812,F23DEB65-9E0F-43BB-92F1-126D200A0DF2,50C0CC12-0DED-4C24-8760-633D670FAA9E,76E3356A-DD3E-4824-A376-723AD778A4F8,A3196E35-7E77-4F6F-B685-09AA5B8AD6B0,4AE08DF9-56EE-4F65-89A6-5045DCFF333B,A12B02B7-E03C-47A3-8988-094140140FB1,E6B70CE1-D649-4906-ABE0-81445C74C0BB,C6EA27B1-5A78-4E9A-BA2E-E9E0B69AF295,741454E2-5814-4080-AD2D-DF32C4A29584,9BAC6D4A-5928-4F6C-8F9C-84B7D75D31FF,72D9D27C-820E-42F4-A068-254F4280F8BD,CB946372-F970-4045-A5BE-91679F1E3650,68A1DE48-E0B7-49DE-8068-4311A2A3DE02,AFF49913-075C-46F4-998C-3A955D18E287,19C64164-71A0-43CA-8B35-6FF3416D7A33,EEF0FD5A-1A80-4624-826C-CA25601A22E7,14CB4BA4-61F5-481A-9FCE-C6C441D8D511,E74D3D84-545B-4FDE-A190-7F047E32CD05,53620482-70AF-4B4F-9DA5-22B946BDBAA4,496B1D39-38F0-499C-920B-55552690C3F0,39239087-9B35-4F37-AEB8-5D909A85B555,21C9E717-A42B-4729-95A6-4EB417895980,BAA282EE-477D-4BBA-A683-EF0B061C0F9B,45C2F5C9-7C40-4EB3-9DA4-437F75C63580,E3694748-93C0-414B-BE9C-1C46829ECEB7,9C291202-8E90-4FF1-A6B6-DD3BD4023348,4D6425CB-2660-48F2-B647-2B5A78BD46DE,697F7A7A-B28B-438C-9500-85CD820946B9,99F2BB1D-30F1-4587-8969-D4384E47129B,D530F3C1-BF94-439C-8733-C6599FFEC687,B5C192BB-6B46-4FB6-8459-A96F6B54CC72,F1109646-299D-4C61-A52A-5D2CC3CF527E,9E9A5800-5C0A-4FA0-AE0C-CB7DA4EE242D,C72A67C0-3F9D-4574-A6F4-8466FE17900C,AB9A6D29-9583-475C-A6B6-A874DB4D337D,45418AD8-9691-4C8B-B059-873BF1113D11,E9C5D37A-AE21-4A69-BD40-4C749D0F96B0,A88AC32C-9CBA-4B04-9F3D-9642A94AFB6D,D1B198BA-D96B-419A-9BCC-D1B5FD421A6D,2B39FD08-56B9-492C-A17F-9A97D77E97D4,B78AE916-371F-4565-B3B1-30E4C6964D3A,F1891B7E-6221-4BA3-924A-8343B1E14257,737E896C-D12D-4A63-84ED-253F52B09EF1,D1646EE5-1919-49B8-B56D-6FD46897C61C,8CD67991-4FF6-491F-A483-B96A6CA48B75,0BA90EF6-6E0F-4E14-A08C-07C6F6CCE63B,6F7DD738-1628-43A5-B7CA-EE5D5829B899,17557C25-EC25-4894-8D47-CD4E0D98076E,B63D2F8C-3E55-4207-A9E1-ABAEA2AC9A13,D35E52B7-F57D-4F3D-B819-ED16BE0E9986,8D56372F-6552-46FC-A350-C0D26FD513AF,60F81B69-6508-490A-90A1-E24874CC8D04,0DCD6B4F-33A1-4DD4-87E1-8AECE657E0B6,F5EFA0EF-639F-4997-A776-8E644C465B6A,42C32F33-30B1-4432-A9D4-2BE64FA0AE9B,6057D01A-B7B2-4DE8-8C53-F1C7EC63520A,C0B939A2-595F-444B-BA6B-E9814A5714A1,BAB3DD11-612A-4371-8C10-A01F48FA659B,6E8D90B6-4481-43EA-B1AD-C043CD4F3E1D,839F69FD-6843-42CA-9BFA-43E3E098F3BB,6E76BFF5-6C01-40C4-BCDF-D726FBAEF392,462ED6B8-5C4F-4BA8-9BA8-FB5E7F53C52C,AB5CE36B-9DF0-4C0E-B25C-BC5281BA9046,41503659-72C8-41BB-80DE-C89E90E17D5F,35CB3B69-245B-427D-A466-8336E43888A2,0F0D16E1-8A57-4418-8C46-2068CDCDEBE2,41372786-9BF5-4CF0-B6F3-091497B3256E,E9D72090-CA7D-42F9-B756-3D3C66C57C76,D9E3238C-1432-475C-A946-95AF334249A4,233FB4D0-D8BE-4F20-8A5A-CBAB5339C51C,F4914866-997F-46F3-B358-A81107800CBC,10DA6990-2EE0-47C9-B1C7-804ADDFA14A5,3C421E04-9501-4BC5-A80E-27898F70E59E,C169D964-656A-4833-8A8C-FACE34A020E5,5E8454A0-B37A-44F6-A1F9-6A1596EB514E,4AED0975-18D9-4B6B-BBEA-C75A2AB7BCB9,9E21389B-8FDF-4EA6-91F8-83B637005793,62F5FAD5-29E3-49D9-BEBB-64345EE4BA60,B5E16260-AAC1-47BE-AC1F-ADC0738876F7,922189DD-8A95-4141-B596-220C625B6196,CC2D082E-AC60-454A-A32C-99867A2442B7,BDD72D38-C869-4145-805C-6F4FCB06D7A0,795371B4-D6D9-4CDA-B6E8-ABF2234A88F7,87AF1FB8-2AE3-4B66-88A2-4DBC2D580841,760C4C77-E3DB-41FC-891C-8608819834B0,5A9FEBB5-57AD-42AA-80BD-7C2A6DCBAC84,E88A3B01-8B1E-4512-847F-7AEFC5D79156,37B1ECA8-2324-44F5-8438-4FCBA6D55CB7,3FEE79C4-9D4C-4CA3-9098-C8DFC1C00FAF,DD585B12-3564-4871-B2D6-2C2B542C0A9C,916961F5-48C3-4122-86BE-FCAC391A0026,2CFB0B79-D493-4B9B-A814-7B6643844D5E,048E6561-8124-460E-85D6-2126FABA313F,E83E81D2-08B0-4BF8-A737-F0E0754C0894,6C8308A6-8EC0-4BAF-BD47-E11D085C122A,E216932A-ED59-4582-B8CA-58D294FACBED,69AE5971-44BA-40F1-86D3-8523F0831115,00FE82FD-3FA7-41CC-A06E-D085CADEC1DF,8C3373DB-7E80-4E28-BD14-4AEB4A2FAD98,EAA6183A-912E-43CC-9F77-9DC4389739B0,6EEE48F9-2886-464B-8C76-2CF1A6B54362,0DA13209-3619-4AEC-80CC-43507C958D47,10B8E7FE-2AED-42BC-AA23-F43B1E37B805,D276A66A-0385-459F-A7FA-B9E82056E607,A7F80DB0-5D2D-4961-93B0-9331351AD513,5E66C339-BBD4-4E14-B2B8-3611C73B2A96,C795AF98-0A19-4C88-A1E4-B54DDC03C8F1,D14DAEE8-2E83-4DAB-B113-294BC90D8714,8E8F4039-DDD1-49C8-A6C9-9DEE995237AA,0353C3B9-8A74-4A4D-8798-D904256F5C3E,4BD3FFD6-C6CA-43C8-ADEA-F88EF5E98731,A30F80F7-2F5D-4497-BDD6-438F8EE60AAB,E3316B75-B387-4426-B7D9-7D3FF685D625,F262F961-EA82-44A2-999E-8F7C1DEB26FB,A1FF1421-E7DE-4EE2-874F-3B88C3218428,8F301D44-339E-4F17-A536-F27752F61E96,3A7B68E1-37F5-4F85-A23A-66056518810E,DBFE0ED1-0290-424A-8CD8-D6938E64E6A3,70AEB396-5607-4EE1-8697-A2516E1A1B4A,CEF2C6E1-F004-46D6-B341-1996B6C6B59F,0BC66D52-3D0D-4D1E-B3FD-89838FBE4D49,F1E48A0A-11F5-4038-927E-2EB460C53ABD,363E6D84-06E6-42CC-82D9-879E9429AFDE,00D44FE8-0448-4CCC-949A-1A535003D14B,C7E99B52-A7D7-4998-A1E8-21F1AE388140,6252A020-779D-49F3-BCC6-8373C30453BA,E6AB4DAF-F538-43BB-825D-14FC7E752E59,14647A8C-1474-4E50-A4A2-DEE7CB1CFFA2,2D28901E-1D3A-419B-A587-4D015C6DC608,D5BA1540-7712-4AFA-A40D-97923BE93590,F0B0472D-D4C8-40B2-9CCE-CB453E099A20,BA4A3971-EEC4-4131-86BE-EAFF157DF022,B857E832-76D9-4DC8-8F13-B422D8776122,2F8157D4-A099-4D81-B299-16F23CE5600D,47DB3486-2BBB-4079-BC86-92ECAA0FD1CA,82C84ED0-8039-4CA2-B4F8-67F873C9552E,FEEB627C-8609-48E3-82C2-6DAFCFCDC4AE,B8B5ADF5-0866-4E15-A433-EB86A5F5A02B,5DB5FAC8-CEDE-4E1A-A37E-510A38F50EEE,D5E20DCB-5E1A-4E24-8A10-FA06E42480F2,A0E44B94-803B-4D4F-9CAF-7712F8C51D3E,4F20D974-8D49-4C25-88EE-90F22FC117FC,C9FB3112-3B68-4A9C-9489-B17EBEBB2EAB,5A9CC28E-CD6B-45BB-AD9F-DF12FAA7251D,ADE34975-9DC7-46ED-8EDF-1C5EA01AD989,38263054-EF93-4EB8-9436-FAD5933E5A2C,C02988B7-6C58-44F9-9A15-BB33AEFB83AB,12248FDA-2C7F-48CF-83CB-E93F0DB724FE,AC4D1861-CE25-49ED-B26E-04AE408175E6,F931448B-C404-43B5-A7D3-5CE975D5D090,8184D645-575E-4FDD-A7F7-8D9C54252FE4,D25FE0DF-702A-472E-8A6A-500564BA2C2C,57DA4D98-D1CC-41FC-9D7A-C8E822D5CCCC,1E90BA46-D41E-44CD-8413-71F7A613EBEC,63BDDC23-5887-47A9-B5AD-EC1DC7170D89,DEDB50F3-F6B4-4D57-ACBD-5A888144EBCD,D0EA7BAE-266A-4982-9621-C3F10BBA7F62,7B078E2C-5582-4BBF-B1D1-A09EE05FD854,AC84EFF5-10AC-400B-AB32-A72B9E69B039,0070BD94-CA16-4EA6-8B93-8267F9CB8D7B,CA37D667-25A5-495A-B9F3-AED1F4CD03B1,C5C19608-D735-405A-8FC2-0362EC0C12F3,7B0FD837-2455-499D-B239-14758EC7D910,7571FF06-65FD-473C-923C-D97EA33DC2B2,6AFB5C0B-CACF-4A08-9ED2-E8855B91382E,0D40D427-7762-4C94-A05D-57402B0A2DDF,47FAC9CC-902F-4792-80DE-7664BF130F71,A2C8AEC2-90BF-4D7B-BAB9-AB7B7DAD8688,BD616650-E689-4F34-9699-96633C89ACE6,CD6A2DB3-6CE5-47B5-8590-57BF2B49F849,3F4BDE44-F54F-489E-8282-9BC25562AC44,7E035581-C477-4FCF-B085-51BD5DB79BE8,2F25412D-AFEF-4909-8521-4A0FC583A1A7,7BD4BD26-35C2-45DA-BAED-F35FF327441B,627810B0-D7DA-481D-B457-1C45910FDDFD,116A1065-C0AD-466C-ABC2-8A954F4EC389,F7EA378B-B5FF-4D8E-B997-6BFC521BE86B,746E5A79-F58E-4E33-962A-A778FB85DD68,6A206EBC-AE3D-420A-A839-DF61A01CAB14,4001ED79-FD26-4E38-825A-3A67EE2CF461,9C6EE04F-51EA-47C2-A7FC-D8F634141581,816C0387-AE07-418D-89E0-F6DF0422F4CE,44FCA973-EA01-4DED-A3FA-33DB1883B614,C598BABC-E893-4204-BB97-A28B4E269597,24C48F9C-B4DE-475F-8C86-02FEE18CFB2F,67695212-6B12-4A01-B2D8-681BECBE8CF0,DC466A50-81E6-4C6E-8DF1-25AFD667BED2,F819FE87-1807-40E1-A078-0B6EF68F02A1,4BBF9F52-9772-4ABD-A84C-AB39498F9577,936544FF-3F5D-4E47-A144-C31658C7DA3A,16FB2B67-E232-4951-B5E3-B718B07182FB,8545E4BE-04E4-4EE7-BF48-76F036F946A6,3834732D-4288-4D39-BF9A-1D8A5E6FB1FC,8B856FBF-1220-42F2-A88F-6E08BC1C5486,1A402BB5-E059-49E7-A460-9E488CE509EE,E9158B81-AF37-4925-9A7D-13844FA05540,D6F29081-FEB5-419C-B8E6-A4B1F9DA3BDD,9B3F6E3E-1F81-4C3F-BF84-38CDA18C0866,A38746D9-4DFF-4FD5-B6C3-2C4B15A09956,3C4513C1-254E-442D-85D5-5FC1A0EFC4B6,8E3E0319-D1E0-464E-8E5D-6187D27B3C66,CADC2E25-3D66-47CA-8FC1-5A6D09000BDD,E5E4BAE0-D468-426F-BA44-EA540CF7C51B,FEB10F21-4240-4204-B86F-68542A95AE3B,668C616B-295A-43ED-9A95-9ABEA1992549,D8137066-5924-4245-B34F-529FE9C0169B,541B1C43-2070-43BE-9826-B79EE7DDF153,4B43A776-2612-4228-B50F-E925EC172A68,9C7C6CEE-6255-4B09-982A-C92DE0057B44,A6B1F69C-87D7-4444-81AD-E0EA50760BF4,5475ECAB-EC43-4E74-8EE3-5DEEBE1A74A8,0BC13952-F7B0-4A6F-9D60-CB6A456CEB48,B478C2A1-715A-4CA6-8228-882EBC33AE33'
	
	DECLARE @distmult FLOAT
		          
	SET @distmult = Cast(dbo.[UserPref](@uid, 202) as float) 

	SELECT 
		g.GroupId,
		g.GroupName,
		v.VehicleId, 
		v.Registration, 
		d.DriverId, 
		ISNULL(d.FirstName + ' ', '') + ISNULL(d.Surname,'') AS DriverName, 
		ISNULL(SUM(r.OnEvents) / dbo.ZeroYieldNull(SUM(r.OnEvents + r.OffEvents)),0) AS OnPerc,
		ISNULL(SUM(r.OffEvents) / dbo.ZeroYieldNull(SUM(r.OnEvents + r.OffEvents)),0) AS OffPerc,
		SUM(rpt.DrivingDistance) * 1000.0 * @distmult AS DrivenDistance
	FROM dbo.ReportingCameraOff r
		INNER JOIN dbo.Reporting rpt ON rpt.Date = r.Date AND rpt.DriverIntId = r.DriverIntId AND rpt.VehicleIntId = r.VehicleIntId
		INNER JOIN dbo.Vehicle v ON v.VehicleIntId = r.VehicleIntId
		INNER JOIN dbo.GroupDetail gd ON gd.EntityDataId = v.VehicleId
		INNER JOIN dbo.[Group] g ON g.GroupId = gd.GroupId AND g.IsParameter = 0 AND g.Archived = 0 AND g.GroupTypeId = 1
			AND g.GroupName NOT LIKE '%*%' 
			AND g.GroupName NOT LIKE '%Manage%' 
			AND g.GroupName NOT LIKE '%Phil%'
			AND g.GroupName NOT LIKE '%Temporary%'
			AND g.GroupName NOT LIKE '%$%'
		INNER JOIN dbo.Driver d ON d.DriverIntId = r.DriverIntId
	WHERE v.VehicleId IN (SELECT Value FROM dbo.Split(@vids, ','))
		AND r.Date BETWEEN @sdate AND @edate
	GROUP BY 
		g.GroupId, g.GroupName, 
		v.VehicleId, v.VehicleIntId, v.Registration
		, d.DriverId, d.DriverIntId, ISNULL(d.FirstName + ' ', '') + ISNULL(d.Surname,'')
	HAVING SUM(rpt.DrivingDistance) > 10

GO
