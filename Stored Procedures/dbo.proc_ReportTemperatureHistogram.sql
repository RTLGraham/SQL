SET QUOTED_IDENTIFIER ON
GO
SET ANSI_NULLS ON
GO

CREATE PROCEDURE [dbo].[proc_ReportTemperatureHistogram]
(
	@vids NVARCHAR(MAX),
	@gids NVARCHAR(MAX),
	@sdate DATETIME,
	@edate DATETIME,
	@uid UNIQUEIDENTIFIER,
	@sensorid TINYINT
)
AS

--DECLARE @vids NVARCHAR(MAX),
--		@gids NVARCHAR(MAX),
--		@sdate DATETIME,
--		@edate DATETIME,
--		@uid UNIQUEIDENTIFIER,
--		@sensorid TINYINT

--	SET @vids = N'5de385bf-bfcb-4179-90cb-5aee460b14ad,67b44e7f-6a0e-42e0-9dcf-5ddca2af502e,486a43f1-70d9-46cc-a745-542b6a4d77ce,db3ac174-1cfe-404c-914b-6be9db1b7038,6cd1331b-f7fc-4866-a333-8fee45667f33,d075f7ef-c02e-46e4-91c3-8191f2167f59,a8dc179e-04ab-4483-9141-a95f46b0968b,91d26e73-dbd4-45da-935c-997766c44aa2,2c1a82de-6dcb-4d03-bc21-5f65198b9a84,8016f50d-a2d1-49a9-bc1e-13ae27953390,3708f23a-f7ca-44f0-bb96-a94e80c40dff,c5868274-5850-4762-8ea8-5b5b7c1c2b5b,0bbef81f-92a9-4183-a354-8b15f4b354dd,df0d3e78-19eb-4779-bae8-a974fe4f1b33,9a615ecd-2389-4d20-b0be-8667626a38ba,5081472d-203e-4f21-9cf8-e1f98619361a,26c1acd4-c763-40e0-aa10-6deb1f960a9a,18750389-36c6-4d3e-be79-c54b859ce83b,33a67a70-9935-4214-b7b0-69b7ac228f5c,1860348d-20b5-42cf-ba66-203864ba0461,d103a123-a2a2-4ef1-97df-d184e971fe7b,3aaea81d-20c4-4f24-b022-deca9c7c51b1,cf6e7729-c9e7-4373-beab-895d9a2f1379,bd15d85f-f591-4ab5-881a-65e296715d18,eb5f8ae0-fc95-4d38-87fe-801c22911ca6,f5f18987-540e-44a0-a9eb-bc42699efa30,bd5f9889-8007-4943-9001-46cb3ed2d36f,2d68cb77-fe15-4030-839a-824b6d0806ba,5aab0e74-d39e-483b-aaff-200fb5a56850,46f9f76a-1324-474b-b0bd-6e160c3e8acd,c98b01d1-b2e7-4378-a1a4-d5245cdddf0d,8288801a-186f-4be4-a044-8a4007bd2372,2e7a5e82-702a-4003-bb17-c072a93ed941,2c63ebdd-07d4-4f26-a3a4-c5e18dbcb5cf,0a293ed6-5de5-4b92-bdf0-c8357df9003d,ae9ad52f-7659-4339-bb56-a39ac3923a54,4da5fa6d-8496-4d75-aa6a-4c32b377bdf9'
--	SET @gids = N'906e3bad-7739-44b1-8966-28f8d4f10a09,b04062c4-67fa-41a9-9bfc-4776782653b4'
--	SET @sdate = '2016-03-21 00:00'
--	SET @edate = '2016-03-27 23:59'
--	SET @uid = N'FE90CE6B-0973-4D7B-8157-1C89CFA422F5'
--	SET @sensorid = 4

  --SET @vids = 'FB0C91E1-401B-427B-B3EE-7AC8A4294BF3,9A615ECD-2389-4D20-B0BE-8667626A38BA,6913DDBF-6FAC-4E5B-A33D-0D61CA692791,91D26E73-DBD4-45DA-935C-997766C44AA2,250F5527-CF24-427E-A514-F52F42E7B51A,909FB8A2-A973-4253-99C1-03EAF670C13B,9F754430-BDF3-4F5A-9454-092C21FE247A,5F3CEA35-DCBE-4120-9301-09FF638BF9DF,ABAC69E6-CCCC-4E60-9F81-0B14A2CE8CFD,7A03DFD2-3982-46E8-8C4E-12F297DEE350,8016F50D-A2D1-49A9-BC1E-13AE27953390,FE456C02-2AC4-4813-9473-13F82137005A,53B878DA-091D-4722-B467-1463EE502C19,AD7AE29D-1328-4228-B4C2-194D6C90A266,2F29E214-4249-4412-9927-1BBFF111DF1B,46D70EB7-624A-4F2D-92D7-1DB630EE116F,9264E0AD-E96D-4974-B0FD-1E50DDF18BDD,5AAB0E74-D39E-483B-AAFF-200FB5A56850,1860348D-20B5-42CF-BA66-203864BA0461,2FE4DD9B-905F-477A-A710-218A4E5C6750,EF8191E1-ABED-480F-99C3-243BC4E7EEE7,04D11745-A145-4215-A432-2A5061B9DC17,AF6A1AEC-0BF5-4224-8A04-2BF2659C2739,3636AE89-04DF-4AE1-95AB-2C06253041BA,16DF929B-A773-46D2-900E-2CA8DCF23893,87A3B70E-9B8D-42CB-BB13-2E1C9427331C,2C38D238-E1A6-4E08-B419-345ACB40930F,93431E81-EE44-4EEE-A959-387B6E4F9CE3,D1742CC9-A5E3-434E-A9E8-3A1D858B1DE4,FA6E62CA-3470-4F73-A32D-3C79BF6206A9,A1AE4401-9643-4A36-94C7-3E93BE0646C4,9DFE074E-F8B7-44C0-8BAA-3FB046ED29A2,5146C0B8-5CE5-44E1-A6C6-41D2E201EF76,BD5F9889-8007-4943-9001-46CB3ED2D36F,39512BD9-7CCF-48AD-9623-46CD000D2AC6,B639621D-7C4D-4B91-8DDF-486051D96448,49482BB6-B7CC-40C1-9F61-48728BF61A8E,4DA5FA6D-8496-4D75-AA6A-4C32B377BDF9,2E7984F5-D541-4070-969B-4DEFA0130CB5,9BBD17D4-3BE2-4E29-B550-509AB56CA92F,BF48CB72-BEC8-475E-A8E3-511D485F15BF,486A43F1-70D9-46CC-A745-542B6A4D77CE,AC4A7F16-ACAF-41E5-B7CB-57C1C3123C20,339C8146-9790-4CFE-B974-5819ECC299C0,5DE385BF-BFCB-4179-90CB-5AEE460B14AD,C5868274-5850-4762-8EA8-5B5B7C1C2B5B,F30F1966-C7B8-4980-BFFE-5B930071D32D,C83D509F-26C0-4ED6-9D12-5C5D9716789D,67B44E7F-6A0E-42E0-9DCF-5DDCA2AF502E,2C1A82DE-6DCB-4D03-BC21-5F65198B9A84,991F0624-E911-4A0A-9E34-632B912A9C38,BD15D85F-F591-4AB5-881A-65E296715D18,24D1F780-C878-4FF0-A6D8-68B5FDA92CBB,33A67A70-9935-4214-B7B0-69B7AC228F5C,DB3AC174-1CFE-404C-914B-6BE9DB1B7038,8780C077-1BCB-4EF9-AC7A-6D763D0B5721,AB2E895D-CB6F-4BD9-8CF1-71E976E6F335,C7343CE2-50EF-4AA2-AAAC-736442ECFA0A,14337BBF-9F3F-4624-9B84-73CB3485BDEE,202B4D58-3993-43D1-A8C5-7BC46C7CEFA5,EB5F8AE0-FC95-4D38-87FE-801C22911CA6,A2A7640A-7CD1-48D3-8270-80A8F2C9FA63,2D68CB77-FE15-4030-839A-824B6D0806BA,6F6C50EC-608F-4528-A69C-838BDBECAAF5,2F060A96-D3F8-4363-88D1-86D6F605976E,CF6E7729-C9E7-4373-BEAB-895D9A2F1379,8288801A-186F-4BE4-A044-8A4007BD2372,77A0110C-5D6C-493A-9C16-8A59A9ABD5B4,0BBEF81F-92A9-4183-A354-8B15F4B354DD,747C1E8B-7F86-4BB3-9AC3-8C4E319272B2,6CD1331B-F7FC-4866-A333-8FEE45667F33,7DE5AA38-2BA3-4C8F-A488-911911DA6F80,6659A865-3221-4DC1-8682-92B1AEA9251E,5C77C772-4FCA-4040-BDF7-942B2E153FFF,68CF88EA-D828-4D33-A849-9441A63D5E8D,B88446F6-CDEE-456D-9896-9743AEDD4D9A,1D3D521A-9CFF-4B73-BC2E-97ADB314A3A2,061C8BAA-F34C-468E-BB72-9C4162664851,284944F1-4BB4-4ED7-B49D-9E318203E950,767A5BB3-0077-4799-AC91-9E88279E99F1,8C2E8B0E-E258-4F27-8BE6-9EE90EF08614,D92E730A-EAA8-4675-A625-9F9F7E6E7B16,DB306411-629E-445B-8FE9-9FE65C285296,DFB2454E-1286-473B-9215-A38D8717CE57,AE9AD52F-7659-4339-BB56-A39AC3923A54,4DD73B7F-2FC4-4F06-B888-A4C4AA923C58,42C9DA5C-2BF6-4A23-865A-A5AB067F8DFA,3FF3032B-D9DC-4FE8-834B-A6EB6FC3C7CB,4723BA01-21CE-4FFB-85E7-A754BF858BC7,B8C522B8-99C0-4630-A4DE-A7A523437829,3708F23A-F7CA-44F0-BB96-A94E80C40DFF,DF0D3E78-19EB-4779-BAE8-A974FE4F1B33,7F0079D1-5D4E-47D8-AFEA-A9835C3A3D00,F16007E6-0BED-44B4-8725-AE703F1F2285,74EEE16C-CF22-4DE3-B677-B5BBC86BBDC4,D622FBC6-9804-4298-B7D8-B83A04A1E620,3D0FA257-E0E9-4009-9508-BBFFA244F817,D5C0A3B0-0996-4D3C-B7F5-BC360B98B024,F5F18987-540E-44A0-A9EB-BC42699EFA30,2E7A5E82-702A-4003-BB17-C072A93ED941,18750389-36C6-4D3E-BE79-C54B859CE83B,2C63EBDD-07D4-4F26-A3A4-C5E18DBCB5CF,6CC1F03D-9CCB-47CB-8796-C641A5B951C3,BF808915-A86D-4EB8-9804-C64375223662,223B3FF2-E259-4460-B4BD-C6979B626432,EF7D5DF1-3744-4233-ADAE-C6A24B16B87B,B52C20AA-96D0-4249-8EC1-C7751A385D87,0A293ED6-5DE5-4B92-BDF0-C8357DF9003D,383FC529-05E2-4F17-ABD5-C9E08895E29D,09504D20-457C-49EC-A6EE-CC7DAA4C4252,D103A123-A2A2-4EF1-97DF-D184E971FE7B,D9FFD177-BC18-4348-A771-D18F39522D6B,49D600B5-E440-4A61-BF2F-D2C78BA278E6,C98B01D1-B2E7-4378-A1A4-D5245CDDDF0D,3AAEA81D-20C4-4F24-B022-DECA9C7C51B1,28E3452A-A515-45BC-B95F-DED8A0EB1CD8,79626E6C-F770-4223-A2F8-DFDD491578EF,88EADF4C-8B3E-488D-A755-E05AB60B3AE0,5081472D-203E-4F21-9CF8-E1F98619361A,97E3C42B-0940-404F-B0FE-E4AD4981E728,76EE70C2-598A-4C1F-85C0-E5A102CD70F2,53D2962E-9E72-466E-B703-E5BA47474BAD,EA9340A7-EA1D-43F1-A213-E95B7BE2225E,B7EEE367-B07C-4441-86EF-EB7E5613F7EF,87B51B30-B441-4A79-AD36-ED2BAD3E3204,7B27F3D7-3BAC-40AC-9B30-ED9211329331,9208ED3D-1CD6-41B1-B8F4-EDC4F5141869,074D27DA-97B6-42FC-920E-EEF395553804,37415C60-7E05-4F91-8A32-F26DF518CF80,5632AB2C-95E1-4D21-BA04-F6104F5238CC,3554137E-4695-46AC-A678-F6428E995B91,A2609578-A02A-4150-8525-F86F3E0C2177,D075F7EF-C02E-46E4-91C3-8191F2167F59,7D5C3C05-221C-47EF-8DAC-278789C406AE,9B2B5A35-D0D9-4776-BB1F-87B27DBFD2CC,A158F8A8-D73B-4EEF-962B-670C1BAB6696,0FADC446-F107-4EF5-B23A-93CF7EA917E7,16B944D8-7232-4801-9940-A91FE543A68E,02F1446D-BB14-4B9F-9D72-8C13BBFDF9D7,46F9F76A-1324-474B-B0BD-6E160C3E8ACD,6CC16F36-AC7D-4543-970B-01FFC46312AC,2AE7E715-2D66-489B-B5CB-20F7F7C366E9,CC91114F-9556-45C1-8CDC-273CF38264C5,32E1C3A8-4A53-4253-B484-7BD32886567D,10108973-3682-4909-8EDE-7DE5C96C35F9,71A8C714-987A-4DC8-AD30-9E04609FD6B2,B29D1683-94B7-4053-82C1-B2BBB7AB7E1F,C11CA3C8-2F0B-44D8-AB73-C9B1BB304CBB,1E1464B8-34DF-4921-AE13-DBD3364B4B5C,B107D391-6C99-4983-8F12-E68B82E01719'
  --SET @gids = 'D2B5005D-E9C1-4B42-A0C9-0C56B704A392,906E3BAD-7739-44B1-8966-28F8D4F10A09,B04062C4-67FA-41A9-9BFC-4776782653B4,7BF24193-706A-4AC2-93A2-65177209B0E8,EA6FF8F6-F6EA-4632-9607-7B0A8A8A8DDB,139C25F1-80AB-409E-B040-7CA42D79C9F6,BAF921F3-4DF1-42EA-993C-B583484F5554,C1234FEF-CE3B-4826-9FE8-B8560690165B,7F46B04D-0C7D-4FDF-81DC-C15243BE6AD1,9FD8DBD9-99CB-48F3-9EBF-D8C89F3D0E91,F0F5ED40-A37B-4718-863D-FECA640FC5CD,A594E2AA-F397-40A0-963E-FFE3E967CBB3,EAA32F83-B996-4B6D-A621-08C1DC1EE7D5,D0C67A78-12CA-479C-8D1C-4C853462EBD7,65FB8EBE-33FB-4702-B842-5C95CB83A54E,6EE11CF2-8D1E-4337-92B3-7073A25CB50E,F8646301-BE3E-4517-9453-8B3F84F48C7F,54B5400B-8383-48BB-9413-93DC7A06E30F,9479E096-238E-4340-AB2B-955D831C716F,7E073EDE-8EA7-4C9B-B345-D8DDA598522F,5AFCE2C1-C2E8-45D4-B7E0-F0C8F488DF13,CA07AACC-8C47-4D29-B89F-F296E6285433'
  
  --SET @vids = 'FB0C91E1-401B-427B-B3EE-7AC8A4294BF3,9A615ECD-2389-4D20-B0BE-8667626A38BA,6913DDBF-6FAC-4E5B-A33D-0D61CA692791,91D26E73-DBD4-45DA-935C-997766C44AA2,250F5527-CF24-427E-A514-F52F42E7B51A,909FB8A2-A973-4253-99C1-03EAF670C13B,9F754430-BDF3-4F5A-9454-092C21FE247A,5F3CEA35-DCBE-4120-9301-09FF638BF9DF,ABAC69E6-CCCC-4E60-9F81-0B14A2CE8CFD,7A03DFD2-3982-46E8-8C4E-12F297DEE350,8016F50D-A2D1-49A9-BC1E-13AE27953390,FE456C02-2AC4-4813-9473-13F82137005A,53B878DA-091D-4722-B467-1463EE502C19,AD7AE29D-1328-4228-B4C2-194D6C90A266'
  --SET @gids = 'D2B5005D-E9C1-4B42-A0C9-0C56B704A392,906E3BAD-7739-44B1-8966-28F8D4F10A09,B04062C4-67FA-41A9-9BFC-4776782653B4,7BF24193-706A-4AC2-93A2-65177209B0E8,EA6FF8F6-F6EA-4632-9607-7B0A8A8A8DDB,139C25F1-80AB-409E-B040-7CA42D79C9F6,BAF921F3-4DF1-42EA-993C-B583484F5554,C1234FEF-CE3B-4826-9FE8-B8560690165B,7F46B04D-0C7D-4FDF-81DC-C15243BE6AD1,9FD8DBD9-99CB-48F3-9EBF-D8C89F3D0E91,F0F5ED40-A37B-4718-863D-FECA640FC5CD,A594E2AA-F397-40A0-963E-FFE3E967CBB3'
  --SET @vids = '6CC16F36-AC7D-4543-970B-01FFC46312AC,2AE7E715-2D66-489B-B5CB-20F7F7C366E9,CC91114F-9556-45C1-8CDC-273CF38264C5,32E1C3A8-4A53-4253-B484-7BD32886567D,10108973-3682-4909-8EDE-7DE5C96C35F9,71A8C714-987A-4DC8-AD30-9E04609FD6B2,B29D1683-94B7-4053-82C1-B2BBB7AB7E1F,C11CA3C8-2F0B-44D8-AB73-C9B1BB304CBB,1E1464B8-34DF-4921-AE13-DBD3364B4B5C,B107D391-6C99-4983-8F12-E68B82E01719'
  --SET @gids = 'EAA32F83-B996-4B6D-A621-08C1DC1EE7D5,D0C67A78-12CA-479C-8D1C-4C853462EBD7,65FB8EBE-33FB-4702-B842-5C95CB83A54E,6EE11CF2-8D1E-4337-92B3-7073A25CB50E,F8646301-BE3E-4517-9453-8B3F84F48C7F,54B5400B-8383-48BB-9413-93DC7A06E30F,9479E096-238E-4340-AB2B-955D831C716F,7E073EDE-8EA7-4C9B-B345-D8DDA598522F,5AFCE2C1-C2E8-45D4-B7E0-F0C8F488DF13,CA07AACC-8C47-4D29-B89F-F296E6285433'
--SET @vids = N'284944F1-4BB4-4ED7-B49D-9E318203E950'
--SET @sdate = '2015-10-05 00:00'
--SET @edate = '2015-10-06 23:59'
--SET @uid = N'FE90CE6B-0973-4D7B-8157-1C89CFA422F5'
--SET @sensorid = 2

DECLARE @lvids NVARCHAR(MAX),
		@lgids NVARCHAR(MAX),
		@lsdate DATETIME,
		@ledate DATETIME,
		@luid UNIQUEIDENTIFIER,
		@gid UNIQUEIDENTIFIER
		
SET @lvids = @vids
SET @lgids = @gids
SET @lsdate = @sdate
SET @ledate = @edate
SET @luid = @uid

DECLARE @tempmult FLOAT,
		@liquidmult FLOAT,
		@analogscaling FLOAT,
		@totalsecs FLOAT

-- Hardcoded values for this report only
SET @analogscaling = 0.00390625
SET @totalsecs = DATEDIFF(ss, @lsdate, @ledate)

-- Convert dates to UTC
SET @lsdate = [dbo].TZ_ToUTC(@lsdate,default,@luid)
SET @ledate = [dbo].TZ_ToUTC(@ledate,default,@luid)

SET @tempmult = Cast(ISNULL(.[dbo].[UserPref](@luid, 214),1) as float)
SET @liquidmult = Cast(ISNULL([dbo].[UserPref](@luid, 200),1) as float)

-- provide the first resultset containing the structure for the histogram
SELECT BucketId, TempLow, TempHigh
FROM dbo.TemperatureHistogramScale
WHERE SensorId = @sensorid

-- Now select data from temporary Event table in cube format for production of histogram
SELECT	g.GroupId,
		g.GroupName,
		v.VehicleId,
		v.Registration,
		ths.BucketId,
		cuberesult.InGeofence,
		cuberesult.Duration,
		cuberesult.DurationPercent
FROM
(	
	SELECT  
			CASE WHEN (GROUPING(g.GroupId) = 1) THEN NULL
				ELSE ISNULL(g.GroupId, NULL)
			END AS GroupId,

			CASE WHEN (GROUPING(v.VehicleId) = 1) THEN NULL
				ELSE ISNULL(v.VehicleId, NULL)
			END AS VehicleId,

			CASE WHEN (GROUPING(th.InGeofence) = 1) THEN NULL
				ELSE ISNULL(th.InGeofence, NULL)
			END AS InGeofence,

			th.BucketId,

			SUM(th.Duration) AS Duration,
			SUM(th.Duration) / (COUNT(DISTINCT v.VehicleId) * @totalsecs) AS DurationPercent

	FROM    dbo.TemperatureHistogram th
	INNER JOIN dbo.Vehicle v ON v.VehicleIntID = th.VehicleIntID
	INNER JOIN dbo.GroupDetail gd ON v.VehicleId = gd.EntityDataId
	INNER JOIN dbo.[Group] g ON gd.GroupId = g.GroupId 
	WHERE th.SensorId = @sensorid
	  AND th.Date BETWEEN @lsdate AND @ledate
	  AND v.VehicleId IN (SELECT VALUE FROM dbo.Split(@lvids, ','))
	  AND g.GroupId IN (SELECT VALUE FROM dbo.Split(@lgids, ','))
	
	GROUP BY g.GroupId,v.VehicleId, th.InGeofence, th.BucketId WITH CUBE
) cuberesult
LEFT JOIN dbo.Vehicle v ON cuberesult.VehicleId = v.VehicleId
LEFT JOIN [Group] g ON cuberesult.GroupId = g.GroupId
INNER JOIN TemperatureHistogramScale ths ON cuberesult.BucketId = ths.BucketId AND ths.SensorId = @sensorid
WHERE (cuberesult.GroupId IS NOT NULL OR cuberesult.VehicleId IS NULL)
ORDER BY g.GroupName, v.Registration, cuberesult.BucketId, cuberesult.InGeofence
GO
